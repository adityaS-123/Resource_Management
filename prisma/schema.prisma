generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Department {
  id                String   @id @default(cuid())
  name              String   @unique
  description       String?
  head              User?    @relation("DepartmentHead", fields: [headId], references: [id], onDelete: SetNull)
  headId            String?  @unique
  members           User[]   @relation("DepartmentMembers")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model User {
  id                String              @id @default(cuid())
  name              String?
  email             String              @unique
  password          String?
  emailVerified     DateTime?
  image             String?
  role              Role                @default(USER)
  departmentId      String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  userRole          UserRole?
  department        Department?         @relation("DepartmentMembers", fields: [departmentId], references: [id], onDelete: SetNull)
  headedDepartment  Department?         @relation("DepartmentHead")
  accounts          Account[]
  approvalRecords   ApprovalRecord[]
  createdProjects   Project[]           @relation("CreatedProjects")
  sentInvitations   ProjectInvitation[] @relation("InvitedBy")
  completedRequests ResourceRequest[]   @relation("CompletedBy")
  approvedRequests  ResourceRequest[]   @relation("ApprovedBy")
  assignedRequests  ResourceRequest[]   @relation("AssignedToUser")
  resourceRequests  ResourceRequest[]
  sessions          Session[]
  assignedProjects  Project[]           @relation("ProjectUsers")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Project {
  id          String              @id @default(cuid())
  name        String
  client      String
  startDate   DateTime
  endDate     DateTime
  createdById String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  phases      Phase[]
  createdBy   User                @relation("CreatedProjects", fields: [createdById], references: [id])
  invitations ProjectInvitation[]
  users       User[]              @relation("ProjectUsers")
}

model Phase {
  id               String            @id @default(cuid())
  name             String
  duration         Int
  allocatedCost    Float
  projectId        String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  project          Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  resources        Resource[]
  resourceRequests ResourceRequest[]

  @@unique([projectId, name])
}

model ResourceTemplate {
  id               String            @id @default(cuid())
  name             String            @unique
  description      String?
  isActive         Boolean           @default(true)
  approvalLevels   Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  resources        Resource[]
  fields           ResourceField[]
  resourceRequests ResourceRequest[]
}

model ResourceField {
  id                 String            @id @default(cuid())
  name               String
  label              String
  fieldType          ResourceFieldType
  isRequired         Boolean           @default(false)
  defaultValue       String?
  options            String?
  unit               String?
  minValue           Float?
  maxValue           Float?
  resourceTemplateId String
  sortOrder          Int               @default(0)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  resourceTemplate   ResourceTemplate  @relation(fields: [resourceTemplateId], references: [id], onDelete: Cascade)
}

model Resource {
  id                 String            @id @default(cuid())
  resourceType       String            @default("General Resource")
  resourceTemplateId String?
  configuration      String
  quantity           Int
  consumedQuantity   Int               @default(0)
  costPerUnit        Float
  phaseId            String
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  identifier         String?
  phase              Phase             @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  resourceTemplate   ResourceTemplate? @relation(fields: [resourceTemplateId], references: [id])
}

model ResourceRequest {
  id                 String            @id @default(cuid())
  userId             String
  phaseId            String
  resourceTemplateId String?
  resourceType       String?
  resourceId         String?
  requestedConfig    String
  requestedQty       Int
  justification      String?
  status             RequestStatus     @default(PENDING)
  currentLevel       Int               @default(0)
  requiredLevels     Int               @default(0)
  rejectionReason    String?
  createdAt          DateTime          @default(now())
  approvedAt         DateTime?
  approvedById       String?
  assignedToIT       Boolean           @default(false)
  itTaskDetails      String?
  completedAt        DateTime?
  completedById      String?
  completionNotes    String?
  credentials        String?
  assignedToUserId   String?
  assignedAt         DateTime?
  updatedAt          DateTime          @updatedAt
  approvals          ApprovalRecord[]
  completedBy        User?             @relation("CompletedBy", fields: [completedById], references: [id])
  approvedBy         User?             @relation("ApprovedBy", fields: [approvedById], references: [id])
  assignedToUser     User?             @relation("AssignedToUser", fields: [assignedToUserId], references: [id])
  resourceTemplate   ResourceTemplate? @relation(fields: [resourceTemplateId], references: [id])
  phase              Phase             @relation(fields: [phaseId], references: [id])
  user               User              @relation(fields: [userId], references: [id])
}

model ProjectInvitation {
  id          String           @id @default(cuid())
  email       String
  projectId   String
  invitedById String
  status      InvitationStatus @default(PENDING)
  emailSent   Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  invitedBy   User             @relation("InvitedBy", fields: [invitedById], references: [id])
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([email, projectId])
}

model ApprovalRecord {
  id                String          @id @default(cuid())
  resourceRequestId String
  approverId        String
  approvalLevel     Int
  status            ApprovalStatus  @default(PENDING)
  comments          String?
  approvedAt        DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  approver          User            @relation(fields: [approverId], references: [id])
  resourceRequest   ResourceRequest @relation(fields: [resourceRequestId], references: [id], onDelete: Cascade)

  @@unique([resourceRequestId, approvalLevel])
}

enum Role {
  ADMIN
  USER
}

enum RequestStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  ASSIGNED_TO_IT
  COMPLETED
}

enum ResourceFieldType {
  TEXT
  NUMBER
  SELECT
  BOOLEAN
  EMAIL
  URL
  TEXTAREA
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum UserRole {
  DEPARTMENT_HEAD
  IT_HEAD
  ADMIN
  IT_TEAM
  REGULAR_USER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}
